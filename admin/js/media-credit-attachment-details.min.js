/*! media-credit media-credit-attachment-details.js 2017-01-29 9:01:08 PM */
!function(a){var b=$mediaCredit||{};b.autoComplete=function(b,c,d){var e=function(a){b.model.set({mediaCreditAuthorID:"",mediaCreditAuthorDisplay:a,mediaCreditText:a}),d&&b.model.save()};return b.$el.find(c).autocomplete({autoFocus:!0,minLength:2,source:$mediaCredit.names||($mediaCredit.names=_.map($mediaCredit.id,function(a,b){return{id:b,value:a,label:a}})),select:function(c,e){return a(this).attr("value",e.item.value),b.model.set({mediaCreditAuthorID:e.item.id,mediaCreditAuthorDisplay:e.item.value,mediaCreditText:e.item.value}),d&&b.model.save(),!1},response:function(c,d){var f;if(0===d.content.length)return f=a(this).val(),f!==b.model.get("mediaCreditAuthorDisplay")&&e(f),!1},open:function(){return a(this).autocomplete("widget").css("z-index",2e6),!1}}).click(function(){this.select()}).change(function(c){var f=a(this),g=f.val(),h=$mediaCredit.noDefaultCredit||!1;h&&""===g&&""===b.model.get("mediaCreditAuthorID")?(b.model.set({mediaCreditAuthorID:b.model.get("author"),mediaCreditAuthorDisplay:b.model.get("authorName"),mediaCreditText:b.model.get("authorName")}),d&&b.model.save(),f.val("").attr("placeholder",b.model.get("mediaCreditAuthorDisplay")),c.stopImmediatePropagation(),c.preventDefault()):g!==b.model.get("mediaCreditAuthorDisplay")&&(e(g),c.stopImmediatePropagation(),c.preventDefault())})},wp.media.view.Attachment.Details&&(b.AttachmentDetails=wp.media.view.Attachment.Details.extend({template:function(a){return wp.media.template("attachment-details")(a)+wp.media.template("media-credit-attachment-details")(a)},render:function(){var a,c=$mediaCredit.noDefaultCredit||!1;wp.media.view.Attachment.prototype.render.apply(this,[]),a=b.autoComplete(this,'label[data-setting="mediaCreditText"] input[type="text"]',!0),c?(a.autocomplete("disable"),""!==this.model.get("mediaCreditAuthorID")&&a.val("").attr("placeholder",this.model.get("mediaCreditAuthorDisplay"))):a.autocomplete("enable")},updateSetting:function(b){var c=a(b.target);c.is('input[type="checkbox"]')&&(b.target.value=c.prop("checked")),wp.media.view.Attachment.prototype.updateSetting.apply(this,[b])}}),wp.media.view.Attachment.Details.prototype=b.AttachmentDetails.prototype),wp.media.view.Attachment.Details.TwoColumn&&(b.AttachmentDetailsTwoColumn=wp.media.view.Attachment.Details.TwoColumn.extend({template:function(b){var c=a(a.parseHTML(wp.media.template("attachment-details-two-column")(b)));return a(wp.media.template("media-credit-attachment-details")(b)).insertAfter(c.find(".attachment-compat").prevAll("*[data-setting]")[0]),c},updateSetting:function(a){wp.media.view.Attachment.Details.prototype.updateSetting.apply(this,[a])}}),wp.media.view.Attachment.Details.TwoColumn.prototype=b.AttachmentDetailsTwoColumn.prototype),wp.media.model.Attachment&&(b.AttachmentModel=wp.media.model.Attachment.extend({sync:function(b,c,d){var e,f=null;return _.isUndefined(this.id)?a.Deferred().rejectWith(this).promise():("update"===b&&c.hasChanged()&&(e=this.get("nonces"),e&&e.mediaCredit&&e.mediaCredit.update&&(d=d||{},d.context=this,d.data=_.extend(d.data||{},{action:"save-attachment-media-credit",id:this.id,nonce:e.mediaCredit.update,post_id:wp.media.model.settings.post.id}),c.hasChanged()&&(d.data.changes={},d.data.mediaCredit={},$mediaCredit.noDefaultCredit&&""===c.changed.mediaCreditText&&""!==c.get("mediaCreditAuthorID")&&delete c.changed.mediaCreditText,_.each(c.changed,function(a,b){0===b.indexOf("mediaCredit")&&(d.data.changes[b]=this.get(b),delete c.changed[b])},this),d.data.mediaCredit.text=c.get("mediaCreditText"),d.data.mediaCredit.link=c.get("mediaCreditLink"),d.data.mediaCredit.id=c.get("mediaCreditAuthorID"),d.data.mediaCredit.nofollow=c.get("mediaCreditNoFollow")),_.size(d.data.changes)>0&&(f=wp.media.ajax(d),delete d.data.changes,this.updateMediaCreditInEditorContent(a("textarea#content").val(),d),delete d.data.mediaCredit))),"update"!==b||c.hasChanged()?this.constructor.__super__.sync.apply(this,[b,c,d]):f?f:a.Deferred().rejectWith(this).promise())},updateMediaCreditInEditorContent:function(b,c){var d,e=this.get("nonces");b&&e&&e.mediaCredit&&e.mediaCredit.content&&(d=_.extend(c,{data:_.extend(c.data,{action:"update-media-credit-in-post-content",nonce:e.mediaCredit.content,mediaCredit:_.extend(c.data.mediaCredit,{content:b})}),success:function(c){var d;b!==c&&(d=tinymce.get("content"),d&&d instanceof tinymce.Editor&&a("#wp-content-wrap").hasClass("tmce-active")?(d.setContent(c),d.save({no_events:!0})):a("textarea#content").val(c))}}),wp.media.ajax("update-media-credit-in-post-content",d))}}),wp.media.model.Attachment.prototype=b.AttachmentModel.prototype)}(jQuery);